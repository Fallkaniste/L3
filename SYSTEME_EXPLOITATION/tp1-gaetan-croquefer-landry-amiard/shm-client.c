#include <stdlib.h>
#include <stdio.h>
#include <getopt.h>
#include <string.h>
#include <time.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <unistd.h>
#include "shm-common.h"
#include "shm-message.h"

void helpMessage();
void versionMessage();

static struct option options[] =
{
  {"help",0,NULL,'h'},
  {"key-proj-id",1,NULL,'i'},
  {"key-pathname",1,NULL,'p'},
  {"seconds",1,NULL,'s'},
  {"times",1,NULL,'t'},
  {"version",0,NULL,'v'}
};

static long key_proj_id=1;
static char* key_pathname="file.ftok";
static long seconds=1;
static long times=-1;
static shm_message_t message;

int main(int argc, char** argv)
{
  int opt = 0;
  key_t key;
  int sharedMemoryId;
  shm_message_t* shmaddr=NULL;

  shm_message_set_name(&message, "Default Name");
  shm_message_set_text(&message, "This is the default message text");

  do
  {
    opt=getopt_long(argc,argv,"hvi:n:p:s:t:x:", options,NULL );
    switch(opt)
    {
      case 'h':
        helpMessage();
        return 0;
      case 'i':
        key_proj_id=strtol(optarg,NULL,10);
        break;
      case 'p':
        key_pathname=optarg;
        break;
      case 'n':
        if(shm_message_set_name(&message,optarg)==-1)
        {
          printError(NULL,argv[0], __FILE__, __LINE__, optarg, (int)strlen(optarg),SHM_MESSAGE_NAME_SIZE);
        }
        break;
      case 's':
        seconds=strtol(optarg,NULL,10);
        break;
      case 't':
        times=strtol(optarg,NULL,10);
        break;
      case 'v':
        versionMessage();
        return 0;
      case 'x':
        if(shm_message_set_text(&message,optarg)==-1)
        {
          /*printf("%s %s %d %s %d %d", argv[0], __FILE__, __LINE__, optarg, (int)strlen(optarg),SHM_MESSAGE_TEXT_SIZE);*/
          printError(NULL, argv[0], __FILE__, __LINE__, optarg, (int)strlen(optarg),SHM_MESSAGE_TEXT_SIZE);
          /*printError(argv[0], key_pathname, key_proj_id, 0);*/
        }
      default:
        break;
    }
  } while(opt!=-1);

  printf("proj_id = \"%ld\"\npathname = \"%s\"\n", key_proj_id, key_pathname);

  /*envoi de message*/


  key = ftok(key_pathname, key_proj_id);

  sharedMemoryId=shmget(key, sizeof(shm_message_t),0);
  shmaddr=(shm_message_t*)shmat(sharedMemoryId, NULL, 0);

  if(shm_message_copy(message,shmaddr)==-1)
  {
    printError(NULL, argv[0], __FILE__, __LINE__);
  }

  /**/




  /*if(shm_message_set_name(shmaddr,"Default name")!=0 || shm_message_set_text(shmaddr,"This is the default message text")!=0)
   {
     exit(1);
   }*/
  /*while(1)
  {
    if(!shm_message_is_empty(*shmaddr))
    {
      shm_message_print(*shmaddr);
      shm_message_empty(shmaddr);
    }
  }*/


  return 0;
}

void helpMessage()
{
  printf("Options:\n \
  \t-h, --help display this help and exit\n \
  \t-i, --key-proj-id=PROJ_ID set the key project identifier to PROJ_ID (the default value is \"1\")\n \
  \t-n, --message-name=NAME set the message name to NAME (the default value is \"Default name\") \
  \t-p, --key-pathname=PATHNAME set the key pathname to PATHNAME (the default value is \"file.ftok\")\n");
  printf("\t-s, --seconds=SECONDS set the seconds between each try (the default value is \"1\", a value less than or equal to 0 enables the interactive mode where the input stream is read)\n \
  \t-t, --times=TIMES set the number of times this program tries to receive a message (the default value is \"-1\", a negative value means repeat for ever)\n \
  \t-v, --version output version information and exit\n \
  \t-x, --message-text=TEXT set the message text to TEXT (the default value is \"This is the default message text\")\n");
  printf("Report bugs to Croquefer Gaëtan <gaetan.croquefer@etud.univ-pau.fr> and Amiard Landry <landry.amiard@etud.univ-pau.fr>.\n");
}

void versionMessage()
{
  printf("shm-client 20190204\nCopyright (C) 2019 Croquefer Gaëtan and Amiard Landry.\nWritten by Croquefer Gaëtan <gaetan.croquefer@etud.univ-pau.fr> and Amiard Landry <landry.amiard@etud.univ-pau.fr>.\n");
}
