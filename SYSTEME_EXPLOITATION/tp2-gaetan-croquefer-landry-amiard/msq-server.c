#include "msq-common.h"

void helpMessage();
void versionMessage();

static struct option options[]=
{
  {"help", 0, NULL, 'h'},
  {"key-proj-id", 1, NULL, 'i'},
  {"key-pathname", 1, NULL, 'p'},
  {"seconds", 1, NULL, 's'},
  {"times", 1, NULL, 't'},
  {"version", 0, NULL, 'v'}
};

char* argv0;

int main(int argc, char** argv)
{
  int opt=0;
  int key_proj_id=1;
  char* key_pathname="file.ftok";
  int seconds=1;
  int times=-1;
  key_t key=0;
  int messageQueueId;
  msq_message_t message;
  char keyInput;

  argv0=argv[0];

  opterr=0;
  do
  {
    opt=getopt_long(argc, argv, ":hvi:p:s:t:", options, NULL );
    switch(opt)
    {
      case 'h':
        helpMessage();
        exit(EXIT_SUCCESS);
      case 'i':
        key_proj_id=stringToInt(optarg);
        break;
      case 'p':
        key_pathname=optarg;
        break;
      case 's':
        seconds=stringToInt(optarg);
        break;
      case 't':
        times=stringToInt(optarg);
        break;
      case 'v':
        versionMessage();
        exit(EXIT_SUCCESS);
      case '?':
        errno=EUO;
        printError(NULL, argv[0],  __FILE__,  __LINE__, optopt);
      case ':':
        errno=EMA;
        printError(NULL, argv[0], __FILE__, __LINE__, optopt);
        break;
    }

  } while(opt!=-1);

  printf("proj_id = \"%d\"\npathname = \"%s\"\n", key_proj_id, key_pathname);

  key=ftok(key_pathname, key_proj_id);
  if(key==-1)
  {
    printError(NULL, argv[0], __FILE__, __LINE__, key_pathname, key_proj_id);
  }

  messageQueueId=msgget(key, IPC_CREAT|IPC_EXCL|0600);
  if(messageQueueId==-1)
  {
    errno=EID;
    printError(NULL, argv[0], __FILE__, __LINE__, key);
  }

  while(times!=0)
  {
    if(seconds>0)
    {
      sleep(seconds);
    }
    else
    {
      printf("Press the Enter key to continue...");
      do
      {
        keyInput=getchar();
      } while(keyInput!=0x0A);
    }
    if(msgrcv(messageQueueId, &message, MSQ_MESSAGE_TEXT_SIZE, 0, IPC_NOWAIT)==-1)
    {
      if(errno!=ENOMSG)
      {
        printError(NULL, argv[0], __FILE__, __LINE__, messageQueueId);
      }
    }
    else
    {
      msq_message_print(message);
    }
    if(times>0)
    {
      times--;
    }
  }
  if(times==0)
  {
    msgctl(messageQueueId, IPC_RMID, NULL);
  }
  exit(EXIT_SUCCESS);
}

void helpMessage()
{
  printf("Usage: ./msq-server.out [OPTION]...\n");
  printf("Receive messages from clients through a message queue.\n\n");
  printf("Options:\n \
  \t-h, --help \n\t\tdisplay this help and exit\n \
  \t-i, --key-proj-id=PROJ_ID \n\t\tset the key project identifier to PROJ_ID (the default value is \"1\")\n");
  printf("\t-p, --key-pathname=PATHNAME \n\t\tset the key pathname to PATHNAME (the default value is \"file.ftok\")\n \
  \t-s, --seconds=SECONDS \n\t\tset the seconds between each try (the default value is \"1\", a value less than or equal to 0 enables the interactive mode where the input stream is read)\n \
  \t-t, --times=TIMES \n\t\tset the number of times this program tries to receive a message (the default value is \"-1\", a negative value means repeat for ever)\n \
  \t-v, --version \n\t\toutput version information and exit\n\n");
  printf("Report bugs to Gaëtan Croquefer <gaetan.croquefer@etud.univ-pau.fr> and Landry Amiard <landry.amiard@etud.univ-pau.fr>.\n");
}

void versionMessage()
{
  printf("msq-server 1.0\n\nCopyright (C) 2019 Gaëtan Croquefer and Landry Amiard.\n\nWritten by Gaëtan Croquefer <gaetan.croquefer@etud.univ-pau.fr> and Landry Amiard <landry.amiard@etud.univ-pau.fr>.\n");
}
