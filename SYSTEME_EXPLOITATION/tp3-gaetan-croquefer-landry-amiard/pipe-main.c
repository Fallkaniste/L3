#include "pipe-common.h"

void helpMessage();
void versionMessage();

static struct option options[]=
{
  {"help", 0, NULL, 'h'},
  {"seconds-for-receiving", 1, NULL, 'r'},
  {"seconds-for-sending", 1, NULL, 's'},
  {"times-for-receiving", 1, NULL, 't'},
  {"times-for-sending", 1, NULL, 'u'},
  {"version", 0, NULL, 'v'},
  {"message-text", 1, NULL, 'x'}
};

char* argv0;

int main(int argc, char** argv)
{
  int opt=0;
  int sendingSeconds=1;
  int receivingSeconds=1;
  int sendingTimes=1;
  int receivingTimes=-1;
  pipe_message_t message;
  char keyInput;
  int pipefd[2];
  int pid=1;

  argv0=argv[0];
  opterr=0;

  if(pipe_message_set_text(&message, "This is the default message text")!=0)
  {
    printError(NULL, argv[0],  __FILE__,  __LINE__, optarg);
  }

  do
  {
    opt=getopt_long(argc, argv, ":hvr:s:t:u:x:", options, NULL );
    switch(opt)
    {
      case 'h':
        helpMessage();
        exit(EXIT_SUCCESS);
      case 'r':
        receivingSeconds=stringToInt(optarg);
        break;
      case 's':
        sendingSeconds=stringToInt(optarg);
        break;
      case 't':
        receivingTimes=stringToInt(optarg);
        break;
      case 'u':
        sendingTimes=stringToInt(optarg);
        break;
      case 'x':
        if(pipe_message_set_text(&message, optarg)!=0)
        {
          printError(NULL, argv[0],  __FILE__,  __LINE__, optarg);
        }
        break;
      case 'v':
        versionMessage();
        exit(EXIT_SUCCESS);
      case '?':
        errno=EUO;
        printError(NULL, argv[0],  __FILE__,  __LINE__, optopt);
      case ':':
        errno=EMA;
        printError(NULL, argv[0], __FILE__, __LINE__, optopt);
        break;
    }

  } while(opt!=-1);


  if(pipe2(pipefd, O_DIRECT)==-1)
  {
    /*TODO ERROR*/
    printError(NULL);
  }

  pid=fork();
  if(pid==0)
  {
    while(sendingTimes!=0)
    {
      if(sendingSeconds>0)
      {
        sleep(sendingSeconds);
      }
      else
      {
        printf("Press the Enter key to write...\n");
        do
        {
          keyInput=getchar();
        } while(keyInput!=0x0A);
      }
      if(pipe_message_set_pid(&message, getpid())!=0)
      {
        printError(NULL, argv[0], __FILE__, __LINE__, getpid());
      }
      if(write(pipefd[1], &message, sizeof(message))==-1)
      {
        /*TODO*/
        printError(NULL);
      }
      pipe_message_print(message, "written");
      if(sendingTimes>0)
      {
        sendingTimes--;
      }
    }
    exit(EXIT_SUCCESS);
  }
  else if(pid==-1)
  {
    /*TODO ERROR*/
    printError(NULL);
  }

  while(receivingTimes!=0)
  {
    if(receivingSeconds>0)
    {
      sleep(receivingSeconds);
    }
    else
    {
      printf("Press the Enter key to read...\n");
      do
      {
        keyInput=getchar();
      } while(keyInput!=0x0A);
    }
    if(read(pipefd[0], &message, sizeof(message))==-1)
    {
      /*TODO*/
      printError(NULL);
    }
    pipe_message_print(message, "read");
    if(receivingTimes>0)
    {
      receivingTimes--;
    }
  }

  exit(EXIT_SUCCESS);
}

void helpMessage()
{
  printf("Usage: ./pipe-main.out [OPTION]...\n");
  printf("Send and receive messages through a pipe.\n\n");
  printf("Options:\n \
  \t-h, --help \n\t\tdisplay this help and exit\n \
  \t-r, --seconds-for-receiving=SECONDS\n\t\tset the seconds between each try to receive a message (the default value is \"1\", a value less than or equal to 0 enables the interactive mode where the input stream is read)\n");
  printf("\t-s, --seconds-for-sending=SECONDS \n\t\tset the seconds between each try to send a message (the default value is \"1\", a value less than or equal to 0 enables the interactive mode where the input stream is read)\n \
  \t-t, --times-for-receiving=TIMES \n\t\tset the number of times this program tries to receive a message (the default value is \"-1\", a negative value means repeat for ever)\n");
  printf("\t-u, --times-for-sending=TIMES \n\t\tset the number of times this program tries to send a message (the default value is \"1\", a negative value means repeat for ever)\n \
  \t-v, --version \n\t\toutput version information and exit\n \
  \t-x, --message-text=TEXT \n\t\tset the message text to TEXT (the default value is \"This is the default message text\")\n\n");
  printf("Report bugs to Gaëtan Croquefer <gaetan.croquefer@etud.univ-pau.fr> and Landry Amiard <landry.amiard@etud.univ-pau.fr>.\n");
}

void versionMessage()
{
  printf("pipe-main 1.0\n\nCopyright (C) 2019 Gaëtan Croquefer and Landry Amiard.\n\nWritten by Gaëtan Croquefer <gaetan.croquefer@etud.univ-pau.fr> and Landry Amiard <landry.amiard@etud.univ-pau.fr>.\n");
}
